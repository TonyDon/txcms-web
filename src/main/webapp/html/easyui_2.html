<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>easyui-demo-1</title>
<link rel="stylesheet" type="text/css" href="../static/jqeasyui/themes/default/easyui.css">
<link rel="stylesheet" type="text/css" href="../static/jqeasyui/themes/icon.css">
<script src="../static/js/jquery-1.11.1.min.js"></script>
<script src="../static/jqeasyui/jquery.easyui.min.js"></script>
<script src="../static/jqeasyui/locale/easyui-lang-zh_CN.js"></script>
<script src="../static/js/common.js"></script>
<script src="../static/js/common-window.js"></script>
<script src="../static/js/jq.md5.js"></script>
<style>
</style>
</head>
<body>


	<table id="sitecat_data_table"></table>
	
	<div id="sitecatAddWin" class="easyui-window" title="添加站点类目"
		data-options="modal:true,closed:true,iconCls:'icon-save'"
		style="width: 350px; height: 280px; padding: 10px;">
		<div style="padding:10px">
	    <form id="sitecatAddFrm" method="post">
				<table cellpadding="5">
					<tr>
						<td>类目名:</td>
						<td><input class="easyui-textbox" type="text" name="name"
							data-options="required:true"></td>
					</tr>
					<tr>
						<td>显示顺序:</td>
						<td><input class="easyui-textbox" type="text" name="dispOrder"
							data-options="required:true"></td>
					</tr>
					<tr>
						<td>状态:</td>
						<td><input class="easyui-textbox" type="text" name="status"
							data-options="required:true"></td>
					</tr>
					<tr>
						<td id="captcha_tit">站点类型:</td>
						<td><input class="easyui-textbox" type="text" name="siteType"
							data-options="required:true"></td>
					</tr>
				</table>
				<div style="text-align: center; padding: 5px">
					<a href="javascript:void(0)" class="easyui-linkbutton"
						data-options="iconCls:'icon-save'" onclick="SITE_CAT.submitAddForm();">提 交</a>
						&nbsp;&nbsp;&nbsp;&nbsp; 
					<a href="javascript:void(0)"
						class="easyui-linkbutton" data-options="iconCls:'icon-clear'"
						onclick="SITE_CAT.clearAddForm();">清 空</a>
				</div>
			</form>
	    </div>
	</div>
	


<script>
initJQuery();



var SiteCatTree = $('#sitecat_data_table');

function convertTreeRows(datas){
	for(var k in datas){
		var rid = datas[k].rid;
		var nodeNum = datas[k].nodeNum;
		datas[k]._parentId = rid; //这里必须用_parentId关联父ID
		if(nodeNum>0){
			datas[k].state='closed';
		}else{
			datas[k].state='open';
		}
	}
	//alert(J.toStr(datas));
	return datas;
};

function parseModel(model) {
	var d = {};
	d.total = model.pageDTO.total;
	d.rows = convertTreeRows(model.pageDTO.datas);
	SiteCatTree.treegrid("options").records = d.total;
	return d;
};

SiteCatTree.treegrid({
	method : 'get',
	title : '站点类目列表',
	iconCls : 'icon-save',
	columns : [ [
	{
		field : 'id',
		title : 'ID',
		width : 50
	}, {
		field : 'name',
		title : '类目名称',
		width : 100
	}, {
		field : 'rid',
		title : '父类ID',
		width : 50
	}, {
		field : 'catPath',
		title : '分类路径',
		width : 80
	}, {
		field : 'dispOrder',
		title : '显示顺序',
		width : 20
	}, {
		field : 'status',
		title : '状态',
		width : 20
	}, {
		field : 'nodeNum',
		title : '节点数',
		width : 20
	}, {
		field : 'siteType',
		title : '站点类型',
		width : 20
	}
	] ],
	idField : 'id',
	treeField: 'name',
	width : '80%',
	height : 350,
	animate: true,
	pagination : true,
	rownumbers : true,
	singleSelect : true,
	remoteSort : false,
	fitColumns : true,
	showFooter : true,
	sortName : 'id',
	sortOrder : 'asc',
	pageSize : 5,
	pageList : [ 5, 10, 20, 50 ],
	records : 0,
	toolbar : [ {
		text : '添加',
		iconCls : 'icon-add',
		handler : function() {
			SITE_CAT.initAdd();
		}
	}, '-', {
		text : '删除',
		iconCls : 'icon-remove',
		handler : function() {
			SITE_CAT.del();
		}
	}, '-', {
		text: '清除选中行',
		iconCls : 'icon-clear',
		handler: function(){
			SiteCatTree.treegrid('clearSelections');
		}
	}],
	loader : function(param, succCall, err) {
		var opts = SiteCatTree.treegrid("options");
		var pgno = param.page;
		var ls = param.rows;
		var cr = (pgno - 1) * ls;
		var rid = param.id || 0 ;
		var params = $.extend({
			rid:rid,
			crow : cr,
			listSize : ls,
			records : opts.records,
			sord : opts.sortOrder,
			sidx : opts.sortName
		}, param);
		$.ajax({
			type : opts.method,
			url : '/txcms-web/sitecat/treelist.json',
			data : params,
			dataType : "json",
			success : function(model) {
				succCall(parseModel(model));
			},
			error : function(xhr, ts) {
				err();
			}
		});
	}
});



var SITE_CAT={};

SITE_CAT.JQ_ADD_FORM = $('#sitecatAddFrm');

SITE_CAT.initAdd = function() {
	$('#sitecatAddWin').window('open');
};

SITE_CAT.clearAddForm = function() {
	this.JQ_ADD_FORM.form('clear');
};

SITE_CAT.submitAddForm = function() {
	var row = SiteCatTree.treegrid('getSelected');
	var curr_rid = !row ? 0 : row.id ;
	this.JQ_ADD_FORM.form('submit', {
			ajax : true,
			queryParams : {
				r : ut.r()
			},
			url : '/txcms-web/sitecat/add.json',
			onSubmit : function(params) {
				params.rid = curr_rid;
				return $(this).form('enableValidation').form('validate');
			},
			success : function(data) {
				var res = jQuery.parseJSON(data)
				if (res.exception || res.validErrors && res.validErrors.length > 0) {
					var msg = [];
					var errs = res.validErrors;
					for ( var k in errs) {
						var err = errs[k].split('@');
						if (err.length == 2) {
							msg.push($('#' + err[1] + '_tit').text() + err[0]);
						} else {
							msg.push(err[0]);
						}
					}
					if(res.exception){
						msg.push(res.exception.replace(/\r|\n/,'<br/>'));
					}
					TxWebWin.alertWarn('添加失败，失败原因：<br/>' + msg.join('<br/>'));
				} else {
					alert('添加成功！');
					SITE_CAT.clearAddForm();
					$('#sitecatAddWin').window('close');
					SiteCatTree.treegrid('reload');
				}
			}
		});
	};
	
SITE_CAT.del = function() {
		var row = SiteCatTree.treegrid('getSelected');
		if (!row) {
			TxWebWin.alert('请单击需要删除的记录, 然后再进行删除.');
		} else {
			$.post('/txcms-web/sitecat/' + row.id + '.json',
					'_method=delete', function(r) {
						if (r.num > 0) {
							alert('删除成功！');
						}
						SiteCatTree.treegrid('clearSelections');
						SiteCatTree.treegrid('reload');
					});
		}
};
</script>








</body>
</html>