<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>add info</title>
<link rel="stylesheet" type="text/css" href="../static/style/common.css">
<link rel="stylesheet" type="text/css" href="../static/bootstrap/css/bootstrap.css">
<link rel="stylesheet" type="text/css" href="../static/bootstrap/css/bootstrap-theme.css">
<link rel="stylesheet" type="text/css" href="../static/jqeasyui/themes/metro/easyui.css">
<link rel="stylesheet" type="text/css" href="../static/jqeasyui/themes/icon.css">
<style>
.w650{width:650px;}
.h50{height:50px;}
</style>
</head>
<body>
<div style="padding:5px;width:800px;text-align:center;" class="easyui-style">
<form id="infoAddFrm" method="post">
<div class="easyui-tabs" style="width:780px;height:auto;">
			<div title="信息分类选择" style="padding: 10px">
			    <p id="siteCat_tip" class="bg-warning">提示：请选择叶子分类发布信息.</p>
				<div class="form-group">
					<label id="siteCat_tit">选择子分类：<span id="selectedCat"></span></label>
					<input type="hidden" id="catId" name="catId" value=""/>
					<ul id="siteCat" class="easyui-tree"></ul>
				</div>
			</div>
			<div title="标签设置" style="padding: 10px">
			This is the help content.
			</div>
			<div title="图片设置" style="padding: 10px">
			This is the help content.
			</div>
			<div title="基本信息输入" style="padding:50px">
				<div class="form-group">
								<label id="title_tit">资讯标题:</label>
								<input class="easyui-validatebox form-control w650 texta" type="text" name="title" data-options="required:true">
				</div>
				<div class="form-group">
								<label id="summary_tit">资讯摘要:</label>
								<textarea class="w650 h50 form-control texta" type="text" name="summary"></textarea>
				</div>
				<div class="form-group">
				 <div class="row">
				 	<div class="col-md-4">
				 				<label id="infoType_tit">资讯类型:</label>
								<select id="infoType" name="infoType" class="form-control input-sm" style="width:100px;"></select>
					</div>
					<div class="col-md-4">
								<label id="isPic_tit">有图文:</label>
								<select class="form-control input-sm" name="isPic" style="width:100px;">
										<option value="">--</option>
										<option value="0">否</option>
										<option value="1">是</option>
								</select>
					</div>
					<div class="col-md-4">
								<label id="isVideo_tit">有视频:</label> 
								<select  class="form-control input-sm" name="isVideo" style="width: 100px;">
										<option value="">--</option>
										<option value="0">否</option>
										<option value="1">是</option>
								</select>
					</div>
				 </div>
				</div>
				<div class="form-group">
								<label id="picUrl_tit">主图地址:</label>
								<input class="w650 form-control texta" type="text" name="picUrl">
				</div>
			</div>
			<div id="infoAddPanle" title="信息内容输入" style="height: auto; margin: auto; padding:9px; text-align: left;">
			   <div class="form-group">
							<label id="content_tit">文章内容:</label>
							<div style="width: 95%; height: 500px; margin: auto; display: block; text-align: left;">
									<textarea  id="editor" name="content" style="width:100%;height:400px;visibility:hidden;">
									请输入文本内容..
									</textarea>
							</div>
				</div>
			</div>
		</div>
		<div style="text-align: center; padding: 5px; clear: both; display: block;">
			 <a href="javascript:void(0)" class="btn btn-primary" role="button"
							onclick="INFO.submitAddForm();">提 交</a>
			 <a href="javascript:void(0)" class="btn btn-danger" role="button"
							onclick="INFO.clearAddForm();">清 空</a>
		</div>
 </form>
</div>


<script src="../static/js/jquery-1.11.3.min.js"></script>
<script src="../ctx.jsp"></script>
<script src="../static/jqeasyui/jquery.easyui.min.js"></script>
<script src="../static/jqeasyui/locale/easyui-lang-zh_CN.js"></script>
<script src="../static/keditor/kindeditor-min.js"></script>
<script src="../static/keditor/lang/zh_CN.js"></script>
<script src="../static/js/common.js"></script>
<script src="../static/js/common-window.js"></script>
<script src="../static/js/common-form.js"></script>
<script src="../static/js/jq.md5.js"></script>
<script src="../static/bootstrap/js/bootstrap.js"></script>
<script>
$(document).ajaxError(globalAjaxErrorHandler);
	
	var editor;
	KindEditor.ready(function(K) {
		editor = K.create('textarea[name="content"]', {
			allowFileManager : true,
			uploadJson: window.SrvCtxPath + '/uploader/store.json',
			filePostName : 'mpfile',
			extraFileUploadParams : {'needThumb':true}
		});
	});

	var INFO = {};
	INFO.JQ_ADD_FORM = $('#infoAddFrm');
	INFO.submitAddForm = function() {
	this.JQ_ADD_FORM.form('submit', {
			ajax : true,
			queryParams : {
				r : ut.r()
			},
			url : window.SrvCtxPath+'/info/add.json',
			onSubmit : function(params) {
				$('#editor').val(editor.html());
				return $(this).form('enableValidation').form('validate');
			},
			success : function(data) {
				var res = jQuery.parseJSON(data)
				if (res.exception || res.validErrors && res.validErrors.length > 0) {
					var msg = [];
					var errs = res.validErrors;
					for ( var k in errs) {
						var err = errs[k].split('@');
						if (err.length == 2) {
							msg.push($('#' + err[1] + '_tit').text() + err[0]);
						} else {
							msg.push(err[0]);
						}
					}
					if(res.exception){
						msg.push(res.exception.replace(/\r|\n/,'<br/>'));
					}
					TxWebWin.alertWarn('添加失败，失败原因：<br/>' + msg.join('<br/>'));
				} else {
					alert('添加成功！');
					INFO.clearAddForm();
				}
			}
		});
	};
	INFO.clearAddForm = function() {
		this.JQ_ADD_FORM.form('clear');
		editor.html('');
	};
	

	

	function initSiteCatTree() {
		var siteCat = $('#siteCat');
		siteCat.tree({
					method : 'get',
					url : window.SrvCtxPath + '/sitecat/treelist.json',
					sortName : 'id',
					sortOrder : 'asc',
					pageSize : 50,
					records : 0,
					loader : function(param, succCall, err) {
						var opts = siteCat.tree("options");
						var rid = param.id || 0;
						var params = $.extend({
							rid : rid,
							crow : 0,
							listSize : opts.pageSize,
							records : opts.records,
							sord : opts.sortOrder,
							sidx : opts.sortName
						}, param);
						$.ajax({
									type : opts.method,
									url : window.SrvCtxPath + '/sitecat/treelist.json',
									data : params,
									dataType : "json",
									success : function(model) {
										var ds = model.pageDTO.datas;
										for ( var k in ds) {
											var rid = ds[k].rid;
											var nodeNum = ds[k].nodeNum;
											ds[k]._parentId = rid; //这里必须用_parentId关联父ID
											ds[k].text = ds[k].name;
											ds[k].attributes = {'nodeNum':nodeNum};
											if (nodeNum > 0) {
												ds[k].state = 'closed';
											} else {
												ds[k].state = 'open';
											}
										}
										var d = $.extend(ds, {});
										siteCat.tree("options").records = model.pageDTO.total;
										succCall(d);
									},
									error : function(xhr, ts) {
										err();
									}
								});
					},
					onClick: function(node){
						if(node.attributes['nodeNum']===0){
							$('#catId').val(node.id);
							$('#selectedCat').text(node.text);
							$('#siteCat_tip').hide();
						}else{
							$('#siteCat_tip').show();
						}
					}
				});
	};


	
	$(function() {
		$('#infoType').txwebInitSelect({
			'url' : window.SrvCtxPath + '/config/dict/jsonp',
			'params' : {
				'dictCode' : 'INFO_TYPE'
			},
			'selectedIndex' : -1,
			'callfunc' : function(data, val) {
				console.log(val);
			},
			'valueName' : 'dictValue',
			'textName' : 'name',
			'defaultText' : '--'
		});

		initSiteCatTree();
	});
</script>








</body>
</html>